-- TODO field "weight" not necessary in linksByLevel

json = require "json"

console.clear()
gui.clearGraphics()

-- Program
NOM_SAVESTATE = "C:/Users/10131571/Documents/maria/Super Mario World (Europe) (Rev 1).Snes9x.QuickSave1.State"
NB_GENERATIONS = 100
RESTORE = nil
--RESTORE = json.decode('{"neuronsByLevel":[[{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":1},{"value":1},{"value":1},{"value":0},{"value":1},{"value":1},{"value":0},{"value":1},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":1},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0},{"value":0}],[{"value":1.8328029677032},{"value":2.0040459328415},{"value":0.7193899880888},{"value":0.73699672379087},{"value":0.80347664213971}],[{"value":0.93099784723924},{"value":1.0196993316272}]],"linksByLevel":[[[{"weight":0.055083350912583},{"weight":0.12067261871781},{"weight":0.16461970554219},{"weight":0.055243620137405},{"weight":0.22043371213707}],[{"weight":0.060135998505727},{"weight":0.19349048304896},{"weight":0.17904907638919},{"weight":0},{"weight":0.061086836311542}],[{"weight":0.083031397105324},{"weight":0.40748065164974},{"weight":0.26492850230985},{"weight":0.14885875955753},{"weight":0.0088550009691019}],[{"weight":0.14416114365012},{"weight":0.12252182834627},{"weight":0.18304411674368},{"weight":0.062407118690591},{"weight":0.18583791379609}],[{"weight":0.0011982155571092},{"weight":0.085758278309554},{"weight":0.087357512386539},{"weight":0.01207474130458},{"weight":0.045768573164368}],[{"weight":0.26087914211535},{"weight":0.416813196561},{"weight":0.072657734090799},{"weight":0},{"weight":0.039491936200804}],[{"weight":0.050690470295708},{"weight":0.11547880011432},{"weight":0.36988745659521},{"weight":0.41531607895132},{"weight":0.084413677724741}],[{"weight":0.073160746092692},{"weight":0.092370706811807},{"weight":0.16362344946705},{"weight":0.39827203028744},{"weight":0.010794389355999}],[{"weight":0.11021789443086},{"weight":0.00027183866965957},{"weight":0},{"weight":0.47603589151021},{"weight":0}],[{"weight":0.11547437945398},{"weight":0.048140216161985},{"weight":0.22785467808477},{"weight":0.20037742023054},{"weight":0.24256642535154}],[{"weight":0.2285971838083},{"weight":0.39094429360418},{"weight":0.057488347331554},{"weight":0.26338546938282},{"weight":0}],[{"weight":0.14318449222159},{"weight":0.36628555954205},{"weight":0.30123655453767},{"weight":0.062232693405092},{"weight":0.16753758329005}],[{"weight":0.10720090778397},{"weight":0.15224228306477},{"weight":0.14899896085629},{"weight":0.43748297131671},{"weight":0.03889443042194}],[{"weight":0.0028200976779276},{"weight":0.14546485035688},{"weight":0.11030659621415},{"weight":0.19394116218242},{"weight":0.047297196016431}],[{"weight":0.038130724404172},{"weight":0.43970073524382},{"weight":0.051480705171426},{"weight":0.20207043241205},{"weight":0.1273432766398}],[{"weight":0.14475427473648},{"weight":0.14456997823902},{"weight":0.049811835021042},{"weight":0.12290524843913},{"weight":0.065652056853168}],[{"weight":0.63529215600002},{"weight":0},{"weight":0.063991113743331},{"weight":0.16251958358729},{"weight":0.29137200103122}],[{"weight":0.11904868097955},{"weight":0.13738090950246},{"weight":0},{"weight":0.20802409728141},{"weight":0.017735591162891}],[{"weight":0.1638987673906},{"weight":0.12831090216829},{"weight":0.046602829428128},{"weight":0.065376322583817},{"weight":0}],[{"weight":0.26449795680998},{"weight":0.13402764559778},{"weight":0.059854509189801},{"weight":0.19287104845448},{"weight":0.23723768437896}],[{"weight":0.19541988841303},{"weight":0.040682011121862},{"weight":0.20301886435946},{"weight":0.25381865052521},{"weight":0.092703211397985}],[{"weight":0.2603574075458},{"weight":0.10306716059363},{"weight":0.47081337552231},{"weight":0.15070393644458},{"weight":0.2046102346098}],[{"weight":0.15655825088261},{"weight":0.50609100841343},{"weight":0.14242013508897},{"weight":0.048636368291917},{"weight":0.48044493616386}],[{"weight":0.073176140721936},{"weight":0},{"weight":0.18684763542779},{"weight":0.074474172030732},{"weight":0.10815159720695}],[{"weight":0},{"weight":0.087694229121669},{"weight":0.018791908315791},{"weight":0.086549957646873},{"weight":0.21064365846932}],[{"weight":0.062893770395939},{"weight":0.10708883869932},{"weight":0.084284733108525},{"weight":0.16528192512882},{"weight":0.18228397123915}],[{"weight":0.032389556043672},{"weight":0.090154246372314},{"weight":0.09935983911391},{"weight":0.12482997804629},{"weight":0.098298455652059}],[{"weight":0.086230721550049},{"weight":0.062487042376445},{"weight":0.197738151201},{"weight":0.20128720050744},{"weight":0.74954950255585}],[{"weight":0.2194792315026},{"weight":0},{"weight":0.32192083025975},{"weight":0.15773561706349},{"weight":0.027204449205205}],[{"weight":0.043951759684169},{"weight":0.042096119928709},{"weight":0.32886978821917},{"weight":0.41121792939788},{"weight":0.053818963217663}],[{"weight":0.015364267938614},{"weight":0.043225469351622},{"weight":0.21769427286922},{"weight":0.19962016648598},{"weight":0.38098926614088}],[{"weight":0.068259649187617},{"weight":0.21663460442414},{"weight":0.1080885334756},{"weight":0},{"weight":0.085387472427928}],[{"weight":0.36986320133442},{"weight":0.38008191018936},{"weight":0.38449881284164},{"weight":0.19825069100808},{"weight":0.010856334498435}],[{"weight":0.095099430857392},{"weight":0.0045443318963315},{"weight":0.28180266375255},{"weight":0.067664390520343},{"weight":0.51723224263917}],[{"weight":0.12947995943656},{"weight":0},{"weight":0.088417123463137},{"weight":0},{"weight":0.40383064497699}],[{"weight":0},{"weight":0.15836356507936},{"weight":0.12084779688825},{"weight":0.06941464344094},{"weight":0}],[{"weight":0.16195036932778},{"weight":0.088559162881725},{"weight":0.17362766468201},{"weight":0.056615054681513},{"weight":0.034621725770814}],[{"weight":0.00061427060341206},{"weight":0.073152161054125},{"weight":0.11152202524088},{"weight":0.051969089484651},{"weight":0.077339792171041}],[{"weight":0.077639565913253},{"weight":0.085710269158607},{"weight":0},{"weight":0.48761749572463},{"weight":0.15114840383328}],[{"weight":0.32273954083296},{"weight":0.28877132438797},{"weight":0.024318480069118},{"weight":0.42962130141539},{"weight":0.4278321247245}],[{"weight":0.18262402052883},{"weight":0.21849956414132},{"weight":0.31993131856905},{"weight":0},{"weight":0.51137059187607}],[{"weight":0.031719702665838},{"weight":0.23206075685388},{"weight":0.21704723333501},{"weight":0.11871847963879},{"weight":0.28455836180463}],[{"weight":0.23174278125674},{"weight":0.40165336020633},{"weight":0.13486734343317},{"weight":0.11968122392691},{"weight":0.023395969245242}],[{"weight":0.15633180434741},{"weight":0.1576597638467},{"weight":0.22908220706839},{"weight":0.16504478688607},{"weight":0.38369958735917}],[{"weight":0.02529560615221},{"weight":0.27057247867813},{"weight":0.26423007831533},{"weight":0.021075256903281},{"weight":0.19737180430762}],[{"weight":0.19468475275105},{"weight":0.24428394085343},{"weight":0.10905286101811},{"weight":0.027274752592598},{"weight":0.11304414353894}],[{"weight":0.18232213982887},{"weight":0.13025046784121},{"weight":0.020015258666283},{"weight":0.29239761277088},{"weight":0.16076787742226}],[{"weight":0.0079823629537355},{"weight":0.053604025960019},{"weight":0.37752688543708},{"weight":0.14395662955014},{"weight":0.19075962919175}],[{"weight":0.26067488736251},{"weight":0.64973155372669},{"weight":0.049202699910997},{"weight":0.11357428360665},{"weight":0.12103671618816}],[{"weight":0.21502252399561},{"weight":0.31375157905488},{"weight":0.43710940772021},{"weight":0.29986786678227},{"weight":0}],[{"weight":0.13399421988527},{"weight":0.11982833621387},{"weight":0.006338720769145},{"weight":0.2645723159018},{"weight":0.35119395478069}],[{"weight":0},{"weight":0.62845870531583},{"weight":0.18411236978139},{"weight":0},{"weight":0.41392272825094}],[{"weight":0.061596422443609},{"weight":0.4110003863119},{"weight":0.29028924177676},{"weight":0.24718054518548},{"weight":0.38601078671383}],[{"weight":0.16811831685766},{"weight":0.10122938368222},{"weight":0.026669245215321},{"weight":0.027540549516681},{"weight":0.076268690883243}],[{"weight":0.17733419042765},{"weight":0.088926073951674},{"weight":0.33216666742829},{"weight":0.0095292723080453},{"weight":0.34379752790711}],[{"weight":0.43079601544424},{"weight":0},{"weight":0.24683703208291},{"weight":0.034761314065742},{"weight":0.26353753975305}],[{"weight":0.21670570021784},{"weight":0.20545774026793},{"weight":0.13779965887497},{"weight":0.38756608502851},{"weight":0.31889244943818}],[{"weight":0.14549805358695},{"weight":0.12688553668646},{"weight":0.50960612269521},{"weight":0.10553224075063},{"weight":0.44575977607259}],[{"weight":0.53658309644334},{"weight":0.11503683933929},{"weight":0.020146753287007},{"weight":0.0011804202671289},{"weight":0}],[{"weight":0.22327635206538},{"weight":0.3092532273754},{"weight":0},{"weight":0.1036781818938},{"weight":0.12837570480706}],[{"weight":0.1938633003709},{"weight":0.1702697971424},{"weight":0.041012816442385},{"weight":0.19927213699179},{"weight":0.21357473944146}],[{"weight":0.20280812080138},{"weight":0.57669638418447},{"weight":0.053211203526789},{"weight":0.11724770984599},{"weight":0.10474911766241}],[{"weight":0.012429954830798},{"weight":0.42040041408576},{"weight":0.11606558956174},{"weight":0.24416314610174},{"weight":0.34672222058292}],[{"weight":0.078465242769279},{"weight":0.14628590096199},{"weight":0.074582872706895},{"weight":0.13364581020684},{"weight":0.23880818056171}],[{"weight":0.0051517944967333},{"weight":0.144820137524},{"weight":0.38006972866059},{"weight":0.32341380008216},{"weight":0.017849368953994}],[{"weight":0.25533717903157},{"weight":0.04442700128593},{"weight":0.0031724079054218},{"weight":0.042915814480253},{"weight":0.34646779265289}],[{"weight":0.2334299325886},{"weight":0.038603274902391},{"weight":0.14581812902865},{"weight":0.098937395264333},{"weight":0.17105366535629}],[{"weight":0.4662513054289},{"weight":0.33213092107972},{"weight":0.30392766618396},{"weight":0.13811484847759},{"weight":0.034969679298571}],[{"weight":0},{"weight":0.1933500062828},{"weight":0.088570785343418},{"weight":0.018752501919825},{"weight":0.12005522209831}],[{"weight":0.13855977882763},{"weight":0.31744871286666},{"weight":0.31578838803167},{"weight":0.14457259953381},{"weight":0}],[{"weight":0.31264758786932},{"weight":0.2323515075776},{"weight":0.26405109781484},{"weight":0.13205343313255},{"weight":0.15725242281775}],[{"weight":0.0051109883310118},{"weight":0.064441351153175},{"weight":0.21430493442543},{"weight":0.16148880370333},{"weight":0.1792692701621}],[{"weight":0.24570891796819},{"weight":0.14228116562076},{"weight":0.06175768373097},{"weight":0.10030115012046},{"weight":0.073448826789792}],[{"weight":0.062935621199634},{"weight":0.027469324671625},{"weight":0.09189100518226},{"weight":0.26341063994441},{"weight":0.24928396920914}],[{"weight":0.11396767066315},{"weight":0.12113301182572},{"weight":0.057626244825652},{"weight":0.12979310713157},{"weight":0.14625506163044}],[{"weight":0.054692129616411},{"weight":0.50393892098074},{"weight":0.26803343250278},{"weight":0.013845783880665},{"weight":0.19160076769445}],[{"weight":0.16845200195612},{"weight":0.18468823207307},{"weight":0.040863700089874},{"weight":0.15945119462838},{"weight":0.24139737077543}],[{"weight":0},{"weight":0.28242016076987},{"weight":0.21372955402769},{"weight":0.011531049006731},{"weight":0.20304774797013}],[{"weight":0.10842680510616},{"weight":0.075581632354516},{"weight":0.23327645049351},{"weight":0.50779059910771},{"weight":0.15448391533815}],[{"weight":0.29826406624665},{"weight":0.14602429113335},{"weight":0.25019615033675},{"weight":0.21065151994616},{"weight":0.12717855585401}],[{"weight":0.4530803734033},{"weight":0.31216047700853},{"weight":0.18371197454795},{"weight":0.15391371045912},{"weight":0.45473877673774}],[{"weight":0.64832639264235},{"weight":0.5960623161578},{"weight":0},{"weight":0.21822502438355},{"weight":0.0020746120147329}],[{"weight":0.44622025392897},{"weight":0.16652804124214},{"weight":0.083700367055996},{"weight":0.19307862446124},{"weight":0.23309226283721}],[{"weight":0.054886246818166},{"weight":0.52073199100243},{"weight":0.011382714094385},{"weight":0.22132223228472},{"weight":0.0084329921600655}],[{"weight":0},{"weight":0.062273313771369},{"weight":0.079791012146161},{"weight":0.052328232334104},{"weight":0.083891146399027}],[{"weight":0.31016011791275},{"weight":0.2817277919176},{"weight":0.09974312848339},{"weight":0},{"weight":0.18087153809394}],[{"weight":0},{"weight":0.52094568442429},{"weight":0.065903387622634},{"weight":0.088894899305961},{"weight":0.10676730838278}],[{"weight":0.53628497773386},{"weight":0.096589192808865},{"weight":0.22387056270085},{"weight":0.34567438232894},{"weight":0.26508526166252}],[{"weight":0.20066158424535},{"weight":0.029655269270842},{"weight":0.004261938506928},{"weight":0.17251645761694},{"weight":0.073366825511108}],[{"weight":0.099506979844656},{"weight":0.29858541670373},{"weight":0.41798473462005},{"weight":0.25506704791089},{"weight":0.47264872403575}],[{"weight":0.36900809139253},{"weight":0.12917412750275},{"weight":0.28038888616124},{"weight":0.094039942078871},{"weight":0}],[{"weight":0.33974928935077},{"weight":0},{"weight":0.10583025589211},{"weight":0},{"weight":0.22998907821169}],[{"weight":0.32476163575536},{"weight":0.036754244690655},{"weight":0.035441803197484},{"weight":0.20942807092809},{"weight":0.017199668234852}],[{"weight":0.01784604948192},{"weight":0.25657405440016},{"weight":0.27034482043844},{"weight":0.47522926086388},{"weight":0.31096737251097}],[{"weight":0.28579156986057},{"weight":0.26173160833635},{"weight":0.079953063860176},{"weight":0},{"weight":0.04628552666569}],[{"weight":0.019812108073283},{"weight":0},{"weight":0.058713605953979},{"weight":0.099177875129893},{"weight":0.4440721271418}],[{"weight":0.074830242067183},{"weight":0.37782233529245},{"weight":0.43890821429566},{"weight":0.31266565091995},{"weight":0.071593139096224}],[{"weight":0},{"weight":0.16996738501488},{"weight":0.088446334113856},{"weight":0.074602509516987},{"weight":0.12039111869156}],[{"weight":0.055467418291053},{"weight":0.12939969296905},{"weight":0.22383351383795},{"weight":0.13032692701697},{"weight":0.25717392982698}],[{"weight":0.094627013177183},{"weight":0.21754032938476},{"weight":0.048285950091987},{"weight":0.23943760379048},{"weight":0.13951885694754}],[{"weight":0.0067612304355075},{"weight":0.0084886704501079},{"weight":0.21667683257471},{"weight":0.097665256864401},{"weight":0.15038279440425}],[{"weight":0.065679602695525},{"weight":0},{"weight":0},{"weight":0.2518054773656},{"weight":0.07600681191972}],[{"weight":0.22058952838962},{"weight":0},{"weight":0.028610615687041},{"weight":0.27182720274018},{"weight":0.37120077229496}],[{"weight":0.077351681223761},{"weight":0.16417574302262},{"weight":0.29535715484235},{"weight":0.2936368295435},{"weight":0.070682696526612}],[{"weight":0.28056817786334},{"weight":0.098473190810621},{"weight":0.32506117172451},{"weight":0.015598811683638},{"weight":0}],[{"weight":0.21889175943676},{"weight":0.19524350862722},{"weight":0.026284690791213},{"weight":0.24108008651679},{"weight":0.17713762280721}],[{"weight":0.17540470564203},{"weight":0.066700684687798},{"weight":0.35191775333979},{"weight":0.19788556317464},{"weight":0.27850151466599}],[{"weight":0},{"weight":0.45408582747947},{"weight":0.20482846159588},{"weight":0.2049262043757},{"weight":0.0076683023135062}],[{"weight":0.043687113449524},{"weight":0.22536422781412},{"weight":0},{"weight":0.23274618626826},{"weight":0.29636945691672}],[{"weight":0.28207204888751},{"weight":0.039250616567308},{"weight":0.1406128073927},{"weight":0.27438497347374},{"weight":0.053660728615101}],[{"weight":0.026267296332551},{"weight":0.22880329702137},{"weight":0.20771821428787},{"weight":0.15507869488647},{"weight":0.034894137446674}],[{"weight":0.23586440014538},{"weight":0.022351754264678},{"weight":0.12183029760651},{"weight":0.24757205655114},{"weight":0.068728405045521}],[{"weight":0.15969158519561},{"weight":0.10642166967808},{"weight":0.041091177152535},{"weight":0.13117682263785},{"weight":0.42319503890796}],[{"weight":0.40120373134143},{"weight":0.11889717133292},{"weight":0.21962041345193},{"weight":0.079467177535356},{"weight":0.23862821762615}],[{"weight":0.35561658762924},{"weight":0.23663811584052},{"weight":0.008576426550083},{"weight":0.082722572407227},{"weight":0.20636200906625}],[{"weight":0.41548530613651},{"weight":0.21427752051268},{"weight":0.028347670823986},{"weight":0.26205625329954},{"weight":0.14963617297003}],[{"weight":0.29498975122508},{"weight":0.4724331628923},{"weight":0.44223813923541},{"weight":0.021915689631793},{"weight":0.49922503990928}],[{"weight":0.035519320149067},{"weight":0.26477954746387},{"weight":0.16421525113384},{"weight":0.22981097944565},{"weight":0.2397570630928}],[{"weight":0.31969868837758},{"weight":0.45191668936893},{"weight":0.26696990297823},{"weight":0.42885613046489},{"weight":0.2234410124267}],[{"weight":0},{"weight":0},{"weight":0.12125276180616},{"weight":0},{"weight":0.17137611506711}],[{"weight":0.043627097939303},{"weight":0},{"weight":0.29056355579993},{"weight":0.22367394162318},{"weight":0.24441729390544}],[{"weight":0.43063658300123},{"weight":0.14753663257377},{"weight":0.037382873065891},{"weight":0.25446220592653},{"weight":0.36644380167652}],[{"weight":0.18518904760802},{"weight":0.013719282549018},{"weight":0.16944560455174},{"weight":0},{"weight":0.25371999604996}],[{"weight":0},{"weight":0.086607700786237},{"weight":0.30389853441068},{"weight":0.08584344070558},{"weight":0.20600228129652}],[{"weight":0},{"weight":0.32490496310687},{"weight":0.17758597165879},{"weight":0.18062658177979},{"weight":0.25865702125765}],[{"weight":0.10394628923318},{"weight":0.27795097614269},{"weight":0.1026392879437},{"weight":0.0045430002290047},{"weight":0.16081168246623}],[{"weight":0},{"weight":0.22240087467689},{"weight":0.14372851201547},{"weight":0.41515706914973},{"weight":0.051227713737287}],[{"weight":0.35923579498204},{"weight":0.33130045431891},{"weight":0.056185326661788},{"weight":0.053543693337572},{"weight":0.528648329903}],[{"weight":0.30032930708947},{"weight":0},{"weight":0.17443198119429},{"weight":0.020507196139518},{"weight":0.37473542020239}],[{"weight":0.30449591342167},{"weight":0.11863512202335},{"weight":0.046621099791287},{"weight":0.1290241453864},{"weight":0}],[{"weight":0.22988198008021},{"weight":0.18082441879715},{"weight":0.13949539316129},{"weight":0.17187816604445},{"weight":0.30955170415616}],[{"weight":0.52283253932707},{"weight":0.11324588080724},{"weight":0.11769477226204},{"weight":0.0091616322596065},{"weight":0.081722350230209}],[{"weight":0.06585717193673},{"weight":0.11440759448381},{"weight":0.027729073581812},{"weight":0.25141175532062},{"weight":0.12236649112146}],[{"weight":0.45484566112995},{"weight":0.37706326958097},{"weight":0.32576332030216},{"weight":0.15101959589654},{"weight":0.21992369293734}],[{"weight":0.087335572479465},{"weight":0.16637341084607},{"weight":0.077873651118575},{"weight":0.12625515504682},{"weight":0.26996503956309}],[{"weight":0.13957465703272},{"weight":0.25872884739081},{"weight":0.30946892844579},{"weight":0.064166074252999},{"weight":0.27375303844307}],[{"weight":0},{"weight":0.25904604240886},{"weight":0.2661354946222},{"weight":0},{"weight":0.18931151600776}],[{"weight":0.29150024164749},{"weight":0.011771899119227},{"weight":0.20028908157649},{"weight":0.035581867570381},{"weight":0.29142181421992}],[{"weight":0.25762377407111},{"weight":0.1952432820129},{"weight":0.059050101914081},{"weight":0.096205968406055},{"weight":0.019467771235513}],[{"weight":0.39281584536276},{"weight":0.0973486310831},{"weight":0.15896201612853},{"weight":0.063531906446891},{"weight":0.3607285846044}],[{"weight":0.46532061119379},{"weight":0.124797639685},{"weight":0.014107754620675},{"weight":0.036246009117546},{"weight":0.03613866474808}],[{"weight":0.2109375148032},{"weight":0.30757502341762},{"weight":0.040836547582838},{"weight":0.18910293254626},{"weight":0.096084364911369}],[{"weight":0.12144594024336},{"weight":0.34550434486501},{"weight":0.27208908385042},{"weight":0.11136352066881},{"weight":0.10906203968001}],[{"weight":0.24317905677441},{"weight":0.12620964152416},{"weight":0.12357904358474},{"weight":0.40003465298579},{"weight":0.11284105293854}],[{"weight":0.44161170037564},{"weight":0.34439400044036},{"weight":0.0026558762562345},{"weight":0.27662662162668},{"weight":0.023119808043779}],[{"weight":0.15413528943358},{"weight":0.34673335461237},{"weight":0.14045154271521},{"weight":0.049134001165594},{"weight":0.19507412733934}],[{"weight":0.13474346665474},{"weight":0.091772060927657},{"weight":0.13963861186642},{"weight":0.12046729563489},{"weight":0.029008389290132}],[{"weight":0.23351896115758},{"weight":0.15450934873335},{"weight":0.1715525723118},{"weight":0.083240454372467},{"weight":0.1913516445134}],[{"weight":0.35023595198663},{"weight":0.16229470997889},{"weight":0.20864914260936},{"weight":0.15557057369919},{"weight":0.30140624386031}],[{"weight":0.15346820167548},{"weight":0},{"weight":0.18627170114416},{"weight":0.067366395421479},{"weight":0.15793660338872}],[{"weight":0.070786689764821},{"weight":0.19189563075723},{"weight":0.18916091106462},{"weight":0.017078734093979},{"weight":0.070355044266976}],[{"weight":0.023930020899207},{"weight":0.11429438900381},{"weight":0.16380668003868},{"weight":0},{"weight":0.22860989704519}],[{"weight":0.49576263695388},{"weight":0.083713717631141},{"weight":0},{"weight":0.019383733359889},{"weight":0.11910860740677}],[{"weight":0.037847588962156},{"weight":0.11245943365879},{"weight":0.41976084040873},{"weight":0.077901956840289},{"weight":0.16960350408063}],[{"weight":0.077226768195291},{"weight":0.048359374903269},{"weight":0.02368585047724},{"weight":0.13217136240086},{"weight":0.18225342759957}],[{"weight":0.20037361398762},{"weight":0.2426077567974},{"weight":0.087587799993243},{"weight":0.021138629173746},{"weight":0.08352316579854}],[{"weight":0.27241941248951},{"weight":0.015358408503393},{"weight":0.0032047661355344},{"weight":0.26773513280618},{"weight":0.1699830445234}],[{"weight":0.2813701817949},{"weight":0.26009057677602},{"weight":0.47258738295674},{"weight":0.1475002189542},{"weight":0.066560651782507}],[{"weight":0.14487379360819},{"weight":0.20776563148691},{"weight":0},{"weight":0.2499206941348},{"weight":0.090605963982771}],[{"weight":0.098805532595551},{"weight":0.20780066606409},{"weight":0.15301734375466},{"weight":0.13927557837541},{"weight":0.17002417291765}],[{"weight":0.3422454741933},{"weight":0.31599577378569},{"weight":0.29693088426284},{"weight":0.26752989856368},{"weight":0.030038293036238}],[{"weight":0.076195214934465},{"weight":0.19427042040867},{"weight":0},{"weight":0.20007823920586},{"weight":0.10422618182859}],[{"weight":0.32506116379712},{"weight":0.12617299706617},{"weight":0.25956898809273},{"weight":0.11525409859213},{"weight":0.3420528242928}],[{"weight":0.12844846217711},{"weight":0},{"weight":0.076163621428836},{"weight":0.051106350821506},{"weight":0.041013425429378}],[{"weight":0.29542705268394},{"weight":0.026535544946316},{"weight":0.11239117428644},{"weight":0.43532625288107},{"weight":0}],[{"weight":0.17777377783563},{"weight":0},{"weight":0.24282644982925},{"weight":0.018280294959093},{"weight":0.084552809650787}],[{"weight":0.21792206698384},{"weight":0.25989028764571},{"weight":0.16916107901507},{"weight":0.15159615380498},{"weight":0.044286882460453}],[{"weight":0.081602759150218},{"weight":0.068911004391088},{"weight":0.14132104869074},{"weight":0.020045283216648},{"weight":0.057917568711442}],[{"weight":0.20714750356432},{"weight":0.016813091265063},{"weight":0.056889980500843},{"weight":0.19485413115944},{"weight":0.40782536338083}],[{"weight":0},{"weight":0.039193075116765},{"weight":0},{"weight":0.16367140755079},{"weight":0.26985389677389}],[{"weight":0},{"weight":0.21025943684559},{"weight":0.4547570778396},{"weight":0.020086900413559},{"weight":0.05229386448595}],[{"weight":0.075749984247828},{"weight":0},{"weight":0.020320670170034},{"weight":0.17498885499412},{"weight":0.2028340381935}],[{"weight":0.16578547932754},{"weight":0.52349403789068},{"weight":0.072814911051948},{"weight":0.071056205241429},{"weight":0.17406038679161}],[{"weight":0.053449161924216},{"weight":0.15010887916743},{"weight":0.14803993902313},{"weight":0.1371906341177},{"weight":0.19895684747382}],[{"weight":0.086441161959176},{"weight":0.19482918596466},{"weight":0.22932869588113},{"weight":0.10465114682665},{"weight":0.33361288699721}],[{"weight":0},{"weight":0.054787622811041},{"weight":0.19590588453414},{"weight":0.057160327162713},{"weight":0.22287687463951}],[{"weight":0.085122000294418},{"weight":0.03092692733366},{"weight":0.0062917979743981},{"weight":0.21800698304939},{"weight":0.096923283951678}],[{"weight":0.1300549511392},{"weight":0.34679704694303},{"weight":0},{"weight":0.20038333704788},{"weight":0.21893575040371}],[{"weight":0.18662964374705},{"weight":0.30092265130633},{"weight":0.031240131005368},{"weight":0.16609452971556},{"weight":0.030402696143288}],[{"weight":0.0070514988048549},{"weight":0.160943147941},{"weight":0.30054065434027},{"weight":0.021481926790257},{"weight":0.16439777560569}],[{"weight":0.30889712042947},{"weight":0.11280285413113},{"weight":0.21952362962139},{"weight":0.29046447503702},{"weight":0.1936820683269}],[{"weight":0.14123191445328},{"weight":0.36737595739324},{"weight":0.21482778594622},{"weight":0.14379441450001},{"weight":0.42202537576979}],[{"weight":0.41027855785253},{"weight":0.24171283831588},{"weight":0.19495862973845},{"weight":0.2028266722376},{"weight":0.11462312338948}],[{"weight":0.21672045297136},{"weight":0.17952248372962},{"weight":0.21341801326424},{"weight":0.20403328167379},{"weight":0.27066345213777}],[{"weight":0.1061237773961},{"weight":0.18259675427421},{"weight":0.23245904567308},{"weight":0.082899008796197},{"weight":0.083121473466464}],[{"weight":0.16597603821141},{"weight":0},{"weight":0.10564710670949},{"weight":0.030523004887281},{"weight":0.13342416672712}],[{"weight":0.2530481594684},{"weight":0.43303495759722},{"weight":0.41399447898064},{"weight":0.14837623059731},{"weight":0.59145344466752}],[{"weight":0.15890912245894},{"weight":0.095785693500193},{"weight":0.0024354482507888},{"weight":0.25722109341902},{"weight":0.21113629406476}],[{"weight":0.33970951320199},{"weight":0.19757195810697},{"weight":0.032551084106401},{"weight":0.12188468136621},{"weight":0.088975139839166}],[{"weight":0.10897209394068},{"weight":0.07852724857634},{"weight":0.01090160976571},{"weight":0.27806118768975},{"weight":0.20693476367521}],[{"weight":0.034307098559247},{"weight":0.049937601866885},{"weight":0.073721846868075},{"weight":0},{"weight":0.25381984786118}],[{"weight":0.43361659166341},{"weight":0.058534249282899},{"weight":0.19644900412686},{"weight":0.24651161618572},{"weight":0.52088554467384}],[{"weight":0.13281819988811},{"weight":0.0055422386037257},{"weight":0.41279203856496},{"weight":0.075305413496664},{"weight":0.070125677998636}],[{"weight":0.25927429451678},{"weight":0.32808634195014},{"weight":0.087473875162048},{"weight":0.20566836433517},{"weight":0.60753187145625}],[{"weight":0.21968014229569},{"weight":0.37642731072831},{"weight":0.11636577911026},{"weight":0.29022747708279},{"weight":0}],[{"weight":0.28312063339256},{"weight":0},{"weight":0.10251548491736},{"weight":0.061698809093605},{"weight":0}],[{"weight":0.16403462530759},{"weight":0.17702389948335},{"weight":0},{"weight":0},{"weight":0.24397927579569}],[{"weight":0.1809925708736},{"weight":0},{"weight":0},{"weight":0.31288397531507},{"weight":0.015113989460771}],[{"weight":0.087884449743429},{"weight":0.10054914017555},{"weight":0.19638410161983},{"weight":0.070504526273772},{"weight":0.29416624038457}],[{"weight":0.0058664922596832},{"weight":0.04260367393712},{"weight":0},{"weight":0.49341221714447},{"weight":0.093458195521784}],[{"weight":0.18126881017412},{"weight":0.047255400813565},{"weight":0.083605121179376},{"weight":0.11374966330188},{"weight":0.075380826393568}],[{"weight":0.16669799304431},{"weight":0.0085360644308098},{"weight":0.22554284445969},{"weight":0.19058060852104},{"weight":0.2185918817687}],[{"weight":0.25242987733931},{"weight":0.071542141421322},{"weight":0.077274308524214},{"weight":0.007689627932828},{"weight":0.23066172834085}],[{"weight":0.1052560359136},{"weight":0.039381517876909},{"weight":0.070234774754344},{"weight":0.26247080234026},{"weight":0.0042194760371085}],[{"weight":0.11146694254538},{"weight":0.21623963307146},{"weight":0.019287090248011},{"weight":0.26628962312034},{"weight":0.047092381381309}],[{"weight":0.077298520157367},{"weight":0.19065776815862},{"weight":0.21075986318602},{"weight":0},{"weight":0.2974049310945}],[{"weight":0.057425836077301},{"weight":0.30906257687234},{"weight":0.4648560109348},{"weight":0},{"weight":0.4551296088379}],[{"weight":0.38174673252611},{"weight":0.23720629209177},{"weight":0.1942794091113},{"weight":0.35140308535726},{"weight":0.027343525976558}],[{"weight":0.091457880960212},{"weight":0},{"weight":0},{"weight":0.008742790514698},{"weight":0.37269868246703}],[{"weight":0.34694528543891},{"weight":0.2644712034751},{"weight":0.31547962696495},{"weight":0.20462496569155},{"weight":0.48509508502671}],[{"weight":0.068932392319714},{"weight":0.18685814063159},{"weight":0.054418419420064},{"weight":0.27829312561707},{"weight":0.072118674087176}],[{"weight":0.17898244124213},{"weight":0.3395023143248},{"weight":0.21479077749632},{"weight":0.31788279743791},{"weight":0.034816475467217}],[{"weight":0.067697190152252},{"weight":0.23417944649024},{"weight":0.16665512440712},{"weight":0.15998718322804},{"weight":0.11704229661007}],[{"weight":0.20146629715383},{"weight":0.082022498657495},{"weight":0.30748837718307},{"weight":0.087749781192527},{"weight":0.039961983677176}],[{"weight":0.055843005653928},{"weight":0.17426735516319},{"weight":0.19921440881432},{"weight":0.045065805654316},{"weight":0.37936314902829}],[{"weight":0.39486719245642},{"weight":0.46213139925781},{"weight":0.079642837807869},{"weight":0.28942157934895},{"weight":0.068697367233336}],[{"weight":0.071613558056234},{"weight":0.313873716264},{"weight":0.09576214240459},{"weight":0.25529645637361},{"weight":0.21041452025322}],[{"weight":0.12200921539617},{"weight":0.16581966049841},{"weight":0.21756245440089},{"weight":0.37665668147818},{"weight":0.17444285428761}],[{"weight":0.28165512847862},{"weight":0.27910148452124},{"weight":0.052683691753518},{"weight":0.25724674334633},{"weight":0.2679449002967}],[{"weight":0.085307229005184},{"weight":0.15570729865995},{"weight":0.068494681264465},{"weight":0.1063484559085},{"weight":0.2847155943724}],[{"weight":0.024987357437106},{"weight":0.011738576190386},{"weight":0.0062825859724714},{"weight":0.23451859723017},{"weight":0.46051410950281}],[{"weight":0.023037689011332},{"weight":0.150769204691},{"weight":0.030349372280009},{"weight":0.013102271952097},{"weight":0.089451804954684}],[{"weight":0.069030865946752},{"weight":0.11709740662004},{"weight":0.18686816525603},{"weight":0},{"weight":0.15805506079225}],[{"weight":0.33433638716334},{"weight":0.086513009465116},{"weight":0.29723369392679},{"weight":0.17258973599849},{"weight":0.26632435106779}],[{"weight":0.018412349981295},{"weight":0.30711432760033},{"weight":0},{"weight":0.024133494674429},{"weight":0.042579067602735}],[{"weight":0.29679078388424},{"weight":0.35065730011495},{"weight":0.2312025073368},{"weight":0.13303134787264},{"weight":0.49663689526347}],[{"weight":0.014050742169168},{"weight":0},{"weight":0},{"weight":0.050069788674151},{"weight":0.34901907831179}],[{"weight":0.10502976867873},{"weight":0.096089385746722},{"weight":0.097436247374279},{"weight":0.092918977185858},{"weight":0.2864423244086}],[{"weight":0.0033708897685738},{"weight":0.18509817523369},{"weight":0},{"weight":0.067793465321947},{"weight":0.27741421637168}],[{"weight":0.081093648897998},{"weight":0.17947347205894},{"weight":0.18617116170103},{"weight":0.18732052616894},{"weight":0.41550443969914}],[{"weight":0},{"weight":0.1170060792293},{"weight":0.54324889011275},{"weight":0.13824859668587},{"weight":0.32413994632866}],[{"weight":0.35869381259522},{"weight":0.16674632662012},{"weight":0.050652657648305},{"weight":0.36022395236997},{"weight":0.094283654560227}],[{"weight":0.31377160173681},{"weight":0.23107289582369},{"weight":0.20875206538467},{"weight":0.011756920550257},{"weight":0.035331900283791}],[{"weight":0.063646549866662},{"weight":0},{"weight":0.24078762642217},{"weight":0.4394814365437},{"weight":0.18567962530548}],[{"weight":0.03390239184881},{"weight":0.098935918192646},{"weight":0.35286703204633},{"weight":0.088952855359893},{"weight":0.1343106017447}],[{"weight":0.19044140258976},{"weight":0.222657833238},{"weight":0.033840440874092},{"weight":0.22483076690847},{"weight":0.23669010881786}],[{"weight":0.16557714625968},{"weight":0.28498237870251},{"weight":0.15730735827953},{"weight":0.35200532603963},{"weight":0.1501024903497}],[{"weight":0.096585068282556},{"weight":0.49412654352417},{"weight":0},{"weight":0.13367033053508},{"weight":0.39682734895631}],[{"weight":0.1387352107245},{"weight":0.078882740941465},{"weight":0},{"weight":0.061013762768012},{"weight":0.15194722157998}],[{"weight":0.10662079641312},{"weight":0.42397751788289},{"weight":0.063354162971716},{"weight":0.18757658166647},{"weight":0.49278193156304}],[{"weight":0},{"weight":0.10578390602936},{"weight":0.12136904493061},{"weight":0.13478342295602},{"weight":0.030016596673272}],[{"weight":0.29698948749575},{"weight":0.23050956538637},{"weight":0.13087445655828},{"weight":0.11688653274113},{"weight":0.0042645056132536}],[{"weight":0},{"weight":0.15431615511249},{"weight":0.0079188070781609},{"weight":0.19695592539802},{"weight":0.13147287364896}],[{"weight":0.023169390245011},{"weight":0.1043183787279},{"weight":0.090873992742965},{"weight":0.066326813176383},{"weight":0.19526297116916}],[{"weight":0.098048683507305},{"weight":0.205236406455},{"weight":0.56564444493332},{"weight":0.1533311941634},{"weight":0.17075101858353}],[{"weight":0.25034650797983},{"weight":0.12108918639175},{"weight":0.19065552575523},{"weight":0.067567590759612},{"weight":0.12084305933394}],[{"weight":0.18387646437376},{"weight":0.15245462577705},{"weight":0.1754424156957},{"weight":0.18113212324879},{"weight":0.25077500821912}],[{"weight":0.53422433036349},{"weight":0.13147640101049},{"weight":0.08547386407436},{"weight":0.30868306937001},{"weight":0.17984401159235}],[{"weight":0.13709700090617},{"weight":0.18652644388458},{"weight":0.10005836194843},{"weight":0.086381563383867},{"weight":0.22149373716984}],[{"weight":0.3544787219125},{"weight":0.21446579948037},{"weight":0.045477284226553},{"weight":0.22711988524394},{"weight":0.17441999243269}],[{"weight":0.03056249019368},{"weight":0},{"weight":0.093115545408595},{"weight":0},{"weight":0.55307689582932}],[{"weight":0.07763840792584},{"weight":0.23213578077723},{"weight":0.1116582254196},{"weight":0.24025778065177},{"weight":0.2001723710558}],[{"weight":0.32501541237185},{"weight":0.12819964977993},{"weight":0.15794979716228},{"weight":0.29165087674018},{"weight":0}],[{"weight":0.10446060569712},{"weight":0.35260771404855},{"weight":0.21176593221481},{"weight":0.15937958985697},{"weight":0.15809771072586}],[{"weight":0.21923545575177},{"weight":0.19269003985985},{"weight":0.48976201614545},{"weight":0},{"weight":0.12174932833547}],[{"weight":0.11558321995511},{"weight":0.018826200800639},{"weight":0.075771488256748},{"weight":0.22612423215623},{"weight":0}]],[[{"weight":0.017199803188518},{"weight":0.11204711037298}],[{"weight":0.15481447654574},{"weight":0.1897110895253}],[{"weight":0.41872650018208},{"weight":0.56112844277873}],[{"weight":0.45651824074155},{"weight":0.2479270086508}],[{"weight":0.28558370927598},{"weight":0.15704323447657}]]]}')
INPUTS_X_MAX = 16 -- x
INPUTS_Y_MAX = 16 -- y

-- Réseau
NB_COUCHE_CACHEES = 1
TAILLE_COUCHE_CACHEE = 5
-- Génétique
NB_INDIVIDU_POPULATION = 5
TOP_CLASSEMENT = 0.5 -- keep only part of the ranking
MUTATION_PROBA = 0.5
MUTATION_RATE = 0.25 -- ±%

-- game configuration
GAME_WEIGHT = 256 -- x
GAME_HEIGHT = 256 -- y
INPUTS_WEIGHT = GAME_WEIGHT / INPUTS_X_MAX
INPUTS_HEIGHT = GAME_HEIGHT / INPUTS_Y_MAX
NB_INPUTS = (GAME_WEIGHT / INPUTS_WEIGHT) * (GAME_HEIGHT / INPUTS_HEIGHT)
BUTTONS = {
    "A", -- saute en tournant
    "B", -- saute
    --"X", -- ?
    --"Y", -- ?
    --"Up", -- regarde en l'air ?
    --"Down",
    --"Left",
    --"Right",
}

ENEMY_NEURONNE_VALUE = 1

function neuronIndexFromGridPosition(position)
    return position.x + position.y * INPUTS_X_MAX
end

function gridPositionFromNeuronIndex(neuronIndex)
    return {
        x = neuronIndex % INPUTS_X_MAX,
        y = math.floor(neuronIndex / INPUTS_X_MAX),
    }
end

function drawReseau(reseau)
    local gridWidthOrHeight = math.sqrt(NB_INPUTS)
    local gridCellSize = 6
    -- input
    local distanceFromEdge = 0
    for i = 0, NB_INPUTS - 1 do
        local x = distanceFromEdge + (i % gridWidthOrHeight) * gridCellSize
        local y = distanceFromEdge + math.floor(i / gridWidthOrHeight) * gridCellSize
        local color = reseau.neuronsByLevel[1][i + 1].value == ENEMY_NEURONNE_VALUE and "red" or "white"
        gui.drawRectangle(x, y, gridCellSize, gridCellSize, "black", color)
    end

    -- intermediates
    -- TODO debug&draw
    local largerIntermediates = 0

    -- outputs
    local outputCellSize = 12
    for o = 0, #BUTTONS - 1 do
        gui.drawRectangle(
                gridWidthOrHeight * gridCellSize + largerIntermediates + 10,
                outputCellSize * o,
                outputCellSize,
                outputCellSize,
                "white",
                "black")
    end
end

function getSprites()
    local cameraX = memory.read_s16_le(0x1462)
    local cameraY = memory.read_s16_le(0x1464)

    local sprites = {}
    for i = 0, 12 - 1 do
        local stat = memory.readbyte(0x14c8 + i)
        if stat ~= 0 then
            local spriteX = memory.readbyte(0x14e0 + i) * GAME_WEIGHT + memory.readbyte(0x00e4 + i)
            local spriteY = memory.readbyte(0x14d4 + i) * GAME_HEIGHT + memory.readbyte(0x00d8 + i)

            local cameraSpriteX = spriteX - cameraX
            local cameraSpriteY = spriteY - cameraY

            -- visible by player?
            if 0 < cameraSpriteX and cameraSpriteX < GAME_WEIGHT and 0 < cameraSpriteY and cameraSpriteY < GAME_HEIGHT then
                local sprite = { x = cameraSpriteX, y = cameraSpriteY }
                --gui.drawBox(sprite.x - 1, sprite.y - 1, sprite.x + 1, sprite.y + 1, "blue", "blue")
                table.insert(sprites, sprite)
            end
        end
    end
    return sprites
end

function firstRandomGeneration()
    local population = {}
    for i = 1, NB_INDIVIDU_POPULATION do
        local individu = firstRandomIndividu(NB_INPUTS, #BUTTONS)
        mutateIndividu(individu)
        table.insert(population, individu)
    end
    return population
end

-- Crée la nouvelle basée sur la mutation du #1 avec les N suivants
function nextGeneration(previousGeneration, scoreByIndividu)
    table.sort(scoreByIndividu, function(a, b)
        return a.score > b.score
    end)
    local bestIndividu = scoreByIndividu[1].individu
    if #previousGeneration > 1 and scoreByIndividu[1].score ~= scoreByIndividu[2].score then
        console.log("New generation with a #1 !!!")
    end

    local nextGeneration = {}
    -- evolve the best (for little population)
    if #previousGeneration > 1 then
        local bestItself = reproduireIndividus(bestIndividu, bestIndividu)
        bestItself = mutateIndividu(bestItself)
        table.insert(nextGeneration, bestItself)
    end
    -- keep the best (for little population)
    table.insert(nextGeneration, bestIndividu)
    -- reproduce the best with the others
    while #nextGeneration < #previousGeneration do
        local skipBest = 1
        local otherIndex = math.floor(math.random() * TOP_CLASSEMENT * (#previousGeneration - skipBest)) + skipBest
        local goodIndividu = previousGeneration[otherIndex + 1]
        local childIndividu = reproduireIndividus(goodIndividu, bestIndividu)
        childIndividu = mutateIndividu(childIndividu)
        table.insert(nextGeneration, childIndividu)
    end
    return nextGeneration
end

function firstRandomIndividu(nbInputs, nbOutputs)
    if RESTORE ~= nill then
        return RESTORE
    end

    local neuronsByLevel = {}
    local initialValue = 0
    -- first = input
    local inputs = {}
    table.insert(neuronsByLevel, inputs)
    for x = 1, nbInputs do
        table.insert(inputs, { value = initialValue })
    end
    -- intermediates
    for x = 1, NB_COUCHE_CACHEES do
        local level = {}
        table.insert(neuronsByLevel, level)
        for x = 1, TAILLE_COUCHE_CACHEE do
            table.insert(level, { value = initialValue })
        end
    end
    -- last = outputs
    local outputs = {}
    table.insert(neuronsByLevel, outputs)
    for x = 1, nbOutputs do
        table.insert(outputs, { value = initialValue })
    end

    local linksByLevel = {} -- from level > source neuron index > target neuron index
    for c = 1, #neuronsByLevel - 1 do
        local fromNeuron = {}
        for from = 1, #neuronsByLevel[c] do
            local toNeuron = {}
            for to = 1, #neuronsByLevel[c + 1] do
                table.insert(toNeuron, { weight = 0 })
            end
            table.insert(fromNeuron, toNeuron)
        end
        table.insert(linksByLevel, fromNeuron)
    end

    return {
        neuronsByLevel = neuronsByLevel,
        linksByLevel = linksByLevel,
    }
end

function mutateWeight(weight)
    if math.random() < MUTATION_PROBA then
        local rate = MUTATION_RATE * (math.random() - 0.5)
        weight = weight + rate
        if weight < 0 then
            weight = 0
        end
        if weight > 1 then
            weight = 1
        end
    end
    return weight
end

function mutateIndividu(reseau)
    for c, level in ipairs(reseau.linksByLevel) do
        for f, from in ipairs(level) do
            for l, link in ipairs(from) do
                link.weight = mutateWeight(link.weight)
            end
        end
    end
    return reseau
end

function reproduireIndividus(reseau1, reseau2)
    local neuronsByLevel = {}
    for c = 1, #reseau1.neuronsByLevel do
        local level = {}
        for n = 1, #reseau1.neuronsByLevel[c] do
            table.insert(level, { value = 0 }) -- computed during propagation
        end
        table.insert(neuronsByLevel, level)
    end

    local linksByLevel = {}
    for c = 1, #reseau1.linksByLevel do
        local fromNeuron = {}
        for from = 1, #reseau1.linksByLevel[c] do
            local toNeuron = {}
            for to = 1, #reseau1.linksByLevel[c][from] do
                local weight = (reseau1.linksByLevel[c][from][to].weight + reseau2.linksByLevel[c][from][to].weight) / 2
                table.insert(toNeuron, { weight = weight })
            end
            table.insert(fromNeuron, toNeuron)
        end
        table.insert(linksByLevel, fromNeuron)
    end

    return {
        neuronsByLevel = neuronsByLevel,
        linksByLevel = linksByLevel,
    }
end

function outputActivated(value)
    return value >= 0.5
end

function sigmoid(value)
    return value / (1 + math.exp(-1 * value))
end

function updateInputsRecomputeOutputs(reseau, inputs)
    -- 1st level: inputs
    for i, input in ipairs(inputs) do
        reseau.neuronsByLevel[1][i].value = input
    end

    -- intermediates
    for c = 2, #reseau.neuronsByLevel do
        for n, neuron in ipairs(reseau.neuronsByLevel[c]) do
            local weightedSum = 0.0
            for p, previous in ipairs(reseau.neuronsByLevel[c - 1]) do
                local link = reseau.linksByLevel[c - 1][p][n]
                weightedSum = weightedSum + link.weight * previous.value
            end
            reseau.neuronsByLevel[c][n].value = sigmoid(weightedSum)
        end
    end

    local outputs = {}
    for o, neuron in ipairs(reseau.neuronsByLevel[#reseau.neuronsByLevel]) do
        table.insert(outputs, outputActivated(neuron.value))
    end
    return outputs
end

function computeOutputsThenUpdateButtons(individu)
    local inputs = {}
    for i = 1, NB_INPUTS do
        table.insert(inputs, 0)
    end
    for _, sprite in ipairs(getSprites()) do
        -- convert position from game to input
        local iX = math.floor(INPUTS_X_MAX * (sprite.x / GAME_WEIGHT))
        local iY = math.floor(INPUTS_Y_MAX * (sprite.y / GAME_HEIGHT))
        local i = neuronIndexFromGridPosition({ x = iX, y = iY })

        inputs[i + 1] = ENEMY_NEURONNE_VALUE
    end

    local outputs = updateInputsRecomputeOutputs(individu, inputs)

    local newButtons = {}
    for o, enabled in ipairs(outputs) do
        newButtons[BUTTONS[o]] = enabled
    end
    newButtons.Right = true -- first version: all the way to the right
    joypad.set(newButtons, 1)
    emu.frameadvance()
end

function niveauFini()
    return memory.readbyte(0x0100) == 12
end

function getScore()
    return memory.readbyte(0x0f34)
end

function play(individu)
    savestate.load(NOM_SAVESTATE)
    while true do
        computeOutputsThenUpdateButtons(individu)
        drawReseau(individu)
        if niveauFini() then
            return getScore() -- TODO append time
        end
    end
end

local population = firstRandomGeneration()
for generation = 1, NB_GENERATIONS do
    console.log("Génération " .. generation .. "/" .. NB_GENERATIONS)
    local scoreByIndividu = {}
    for i, individu in ipairs(population) do
        console.log("> Individu " .. i .. "/" .. #population)
        local score = play(individu)
        table.insert(scoreByIndividu, { individu = individu, score = score })
    end

    population = nextGeneration(population, scoreByIndividu)
end
